<form
  class="dynamic-form"
  [formGroup]="form"
  [mustMatch]="configForm.form.matchField"
  (submit)="handleSubmit($event)">
  <ng-container *ngFor="let field of config">
    <ng-container
      [ngTemplateOutlet]="customLayout ? customLayout : defaultLayout"
      [ngTemplateOutletContext]="{field: field, labelContent: labelContent, formContent: formContent, errorContent: errorContent }">
    </ng-container>
  </ng-container>
  <button
    class="reactive-btn-submit"
    [ngClass]="configForm.form.submitButton.extraClass"
    type="submit">
    {{ configForm.form.submitButton.title }}
  </button>
</form>

<ng-template 
  #defaultLayout 
  let-field="field" 
  let-labelContent="labelContent" 
  let-formContent="formContent" 
  let-errorContent="errorContent">
  <div class="label-content">
    <ng-container [ngTemplateOutlet]="labelContent" [ngTemplateOutletContext]="{field: field}"></ng-container> 
  </div>
  <div class="form-content">
    <ng-container [ngTemplateOutlet]="formContent" [ngTemplateOutletContext]="{field: field}"></ng-container> 
  </div>
  <div class="error-content">
    <ng-container [ngTemplateOutlet]="errorContent" [ngTemplateOutletContext]="{field: field}"></ng-container> 
  </div>
</ng-template>

<ng-template #labelContent let-field="field">
  <div>
    <label>{{ field.label}}: </label>
  </div>
</ng-template>

<ng-template #errorContent let-field="field">
  <ng-container *ngIf="submitted && f[field.key].errors">
    <p style="color:red" *ngFor="let error of f[field.key].errors | keyvalue">
      <ng-container *ngIf="customPipe; else noPipe">
        {{ field.errors[error.key] | dynamicPipe: customPipe: customPipeArgs }}
      </ng-container>
      <ng-template #noPipe>
        {{ field.errors[error.key] }}
      </ng-template>
    </p>
  </ng-container> 
</ng-template>


<ng-template #formContent let-field="field">
  <ng-container *ngIf="!field.groups && !field.arrays">
    <ng-container  
      dynamicField
      [submitted]="submitted"
      [components]="componentHandler"
      [config]="field"
      [group]="form">
    </ng-container>
  </ng-container>
  <ng-container *ngIf="field.groups">
    <ng-container *ngFor="let group of field.groups">
      <ng-container  
        dynamicField
        [components]="componentHandler"
        [submitted]="submitted"
        [config]="group"
        [group]="form.controls[field.key]">
      </ng-container>
    </ng-container>
  </ng-container>
  <ng-container *ngIf="field.arrays && form.controls[field.key]">
    <ng-container *ngFor="let ui of form.controls[field.key]['controls']">
      <ng-container *ngFor="let group of field.arrays">
        <ng-container  
          dynamicField
          [submitted]="submitted"
          [components]="componentHandler"
          [config]="group"
          [group]="ui">
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>
