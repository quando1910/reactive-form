<form
  class="dynamic-form"
  [formGroup]="form"
  [mustMatch]="inheritConfig.form.matchField"
  (submit)="handleSubmit($event)">
  <ng-content select="[topForm]"></ng-content>
  <ng-container *ngFor="let field of config">
    <div class="reactive-form-field">
      <ng-container
        [ngTemplateOutlet]="customLayout ? customLayout : defaultLayout"
        [ngTemplateOutletContext]="{field: field, labelContent: labelContent, formContent: formContent, errorContent: errorContent }">
      </ng-container>
    </div>
  </ng-container>
  <ng-content select="[middleForm]"></ng-content>
  <button
    *ngIf="!inheritConfig.form.submitButton.hidden"
    class="reactive-btn-submit"
    [ngClass]="inheritConfig.form.submitButton.extraClass"
    [disabled]="preventClick"
    type="submit">
    {{ inheritConfig.form.submitButton.title }}
  </button>
  <ng-content select="[bottomForm]"></ng-content>
</form>

<ng-template 
  #defaultLayout 
  let-field="field" 
  let-labelContent="labelContent" 
  let-formContent="formContent" 
  let-errorContent="errorContent">
  <div class="label-content">
    <ng-container [ngTemplateOutlet]="labelContent" [ngTemplateOutletContext]="{field: field}"></ng-container> 
  </div>
  <div class="form-content">
    <ng-container [ngTemplateOutlet]="formContent" [ngTemplateOutletContext]="{field: field}"></ng-container> 
  </div>
  <div class="desc-content">
    <ng-container [ngTemplateOutlet]="descContent" [ngTemplateOutletContext]="{field: field}"></ng-container> 
  </div>
  <div class="error-content">
    <ng-container [ngTemplateOutlet]="errorContent" [ngTemplateOutletContext]="{field: field}"></ng-container> 
  </div>
</ng-template>

<ng-template #labelContent let-field="field">
  <div *ngIf="field.label">
    <label>{{field.label}}: </label>
  </div>
</ng-template>

<ng-template #descContent let-field="field">
  <div *ngIf="field.description">
    <span>{{field.description}}</span>
  </div>
</ng-template>

<ng-template #errorContent let-field="field">
  <ng-container *ngIf="submitted && f[field.key].errors">
    <p style="color:red" *ngFor="let error of f[field.key].errors | keyvalue">
      <ng-container *ngIf="customPipe; else noPipe">
        {{ field.errors[error.key] | dynamicPipe: customPipe: customPipeArgs }}
      </ng-container>
      <ng-template #noPipe>
        {{ field.errors[error.key] }}
      </ng-template>
    </p>
  </ng-container> 
</ng-template>


<ng-template #formContent let-field="field">
  <ng-container *ngIf="!field.groups && !field.arrays">
    <ng-container  
      dynamicField
      [submitted]="submitted"
      [components]="componentHandler"
      [config]="field"
      [group]="form">
    </ng-container>
  </ng-container>
  <ng-container *ngIf="field.groups">
    <ng-container *ngFor="let group of field.groups">
      <ng-container  
        dynamicField
        [components]="componentHandler"
        [submitted]="submitted"
        [config]="group"
        [group]="form.controls[field.key]">
      </ng-container>
    </ng-container>
  </ng-container>
  <ng-container *ngIf="field.arrays && form.controls[field.key]">
    <ng-container *ngFor="let ui of form.controls[field.key]['controls']">
      <ng-container *ngFor="let group of field.arrays">
        <ng-container  
          dynamicField
          [submitted]="submitted"
          [components]="componentHandler"
          [config]="group"
          [group]="ui">
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>
